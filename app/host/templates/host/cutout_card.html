{% extends "host/card_template.html" %}

{% load crispy_forms_tags %}

<!-- title -->
{% block title %} <h4> Imaging data </h4>{% endblock %}

<!-- body -->
{% block body %}
<div id="loading-indicator" class="loader"></div>
<div id="cutout-img-div">
    {% if bokeh_cutout_div %}
    {{ bokeh_cutout_div | safe }}
    {% else %}
    <p style="text-align: center;">Click the image to load the interactive plot.</p>
    <button id="cutout-img-button" onclick="cutoutImgClick('{{ transient.name }}', '{{ cutout.name }}')">
        <img id="cutout-img" src="data:image/png;base64,{{ image_data_encoded }}" style="width: 100%;"/>
    </button>
    <br>
    {% endif %}
</div>
<form class="form" , method="POST">
    {% csrf_token %}
    <div class="input-group mb-10">
        {{ filter_select_form.filters }}
        <div class="input-group-append">
            <button class="btn btn-outline-success" type="button"
                onclick="cutoutImgClick('{{ transient.name }}', document.getElementById('id_filters').value)">Get Cutout</button>
        </div>
    </div>
</form>
{% if bokeh_cutout_div %}
{{ bokeh_cutout_div | safe }}
{% endif %}
<script>
    document.getElementById('loading-indicator').style.display = "none";
    function cutoutImgClick(transient, filter) {
        document.getElementById('loading-indicator').style.display = "block";
        document.getElementById('cutout-img-div').style.display = "none";
        $.ajax({
            url: "{% url 'cutout_fits_plot' %}",
            type: "GET",
            data: {
                transient_name: transient,
                filter: filter
            },
            success: function (resp) {
                document.getElementById("cutout-img-div").innerHTML = resp.bokeh_cutout_div;
                document.getElementById("bokeh-cutout-script-wrapper").innerHTML = ''
                var cutout_script = document.createElement("script");
                cutout_script.type = 'text/javascript';
                var raw_script = resp.bokeh_cutout_script;
                var raw_script_trimmed = raw_script.trim();
                var script_trimmed = raw_script_trimmed.replace('<script type="text/javascript">', "").replace("</scr", "").replace("ipt>", "");
                cutout_script.text = script_trimmed;
                document.getElementById("bokeh-cutout-script-wrapper").appendChild(cutout_script);
                document.getElementById('cutout-img-div').style.display = "block";
                document.getElementById('loading-indicator').style.display = "none";
            },
        });
    }
</script>
<style>
    #cutout-img {
        max-width: 100%;
        max-height: 100%;
    }

    #cutout-img-button {
        background: transparent;
        border: none !important;
    }
</style>
<div id="bokeh-cutout-script-wrapper"></div>
{% endblock %}
